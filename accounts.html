<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>SUM</title>
  <link rel="stylesheet" type="text/css" href="styles.css">
  <script src='https://code.jquery.com/jquery-2.1.3.min.js' type='text/javascript'></script>
</head>

<body class="accounts">
  <div class="container">
    <div class="logo">Sum</div>
    <h2 id='title'>Your accounts</h2>
    <div class="sum-total account-item">
      <h1 id='your-sum'></h1>
      <span>Your Sum</span>
    </div>
    <div id='account-items'>
    </div>
  </div>
</body>
  <script>
  // http://stackoverflow.com/a/2880929/1475891
  var parseQueryString = function(query) {
    var match;
    var pl = /\+/g;  // Regex for replacing addition symbol with a space
    var search = /([^&=]+)=?([^&]*)/g;
    var decode = function (s) { return decodeURIComponent(s.replace(pl, " ")); };

    urlParams = {};
    while (match = search.exec(query)) {
       urlParams[decode(match[1])] = decode(match[2]);
    }
    return urlParams;
  };

  var showError = function(message) {
    document.getElementById('account-items').style.display = 'none';
    document.getElementsByClassName('account-item')[0].style.display = 'none';
    document.getElementById('title').innerText = 'We had trouble pulling your accounts.';
  }

  var params = parseQueryString(window.location.search.substring(1));

  if (params.connect_access_token != null) {
    $.ajax({
      url: 'https://connect.plaid.com/accounts',
      type: 'POST',
      data: {connect_access_token: params.connect_access_token},
    }).done(function(data) {
      var accountContainer = document.getElementById('account-items')
      var sum = 0;
      if (data.accounts != null) {
        for (var i = 0, len = data.accounts.length; i < len; i += 1) {
          var account = data.accounts[i];

          var container = document.createElement('div');
          container.className = 'account-item';

          var balanceLabel = document.createElement('h1');
          var balance = account.balance.current == null ? account.balance.available : account.balance.current;
          balanceLabel.innerText = '$' + balance.toFixed(2);
          sum += balance;

          var span = document.createElement('span');
          span.innerText = account.meta.name + ' ' + account.meta.number;

          container.appendChild(balanceLabel);
          container.appendChild(span);
          accountContainer.appendChild(container);
        }

        // Update "Sum"
        document.getElementById('your-sum').innerText = '$' + sum.toFixed(2);
      } else {
        showError();
      }
    }).fail(function(err) {
      showError();
    });
  } else {
    showError();
  }
  </script>
</html>
